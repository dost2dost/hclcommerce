{"ast":null,"code":"var ANode = require('./a-node');\n\nvar bind = require('../utils/bind');\n\nvar debug = require('../utils/debug');\n\nvar registerElement = require('./a-register-element').registerElement;\n\nvar THREE = require('../lib/three');\n\nvar fileLoader = new THREE.FileLoader();\nvar warn = debug('core:a-assets:warn');\n/**\n * Asset management system. Handles blocking on asset loading.\n */\n\nmodule.exports = registerElement('a-assets', {\n  prototype: Object.create(ANode.prototype, {\n    createdCallback: {\n      value: function () {\n        this.isAssets = true;\n        this.fileLoader = fileLoader;\n        this.timeout = null;\n      }\n    },\n    attachedCallback: {\n      value: function () {\n        var self = this;\n        var i;\n        var loaded = [];\n        var mediaEl;\n        var mediaEls;\n        var imgEl;\n        var imgEls;\n        var timeout;\n\n        if (!this.parentNode.isScene) {\n          throw new Error('<a-assets> must be a child of a <a-scene>.');\n        } // Wait for <img>s.\n\n\n        imgEls = this.querySelectorAll('img');\n\n        for (i = 0; i < imgEls.length; i++) {\n          imgEl = fixUpMediaElement(imgEls[i]);\n          loaded.push(new Promise(function (resolve, reject) {\n            // Set in cache because we won't be needing to call three.js loader if we have.\n            // a loaded media element.\n            THREE.Cache.files[imgEls[i].getAttribute('src')] = imgEl;\n            imgEl.onload = resolve;\n            imgEl.onerror = reject;\n          }));\n        } // Wait for <audio>s and <video>s.\n\n\n        mediaEls = this.querySelectorAll('audio, video');\n\n        for (i = 0; i < mediaEls.length; i++) {\n          mediaEl = fixUpMediaElement(mediaEls[i]);\n\n          if (!mediaEl.src && !mediaEl.srcObject) {\n            warn('Audio/video asset has neither `src` nor `srcObject` attributes.');\n          }\n\n          loaded.push(mediaElementLoaded(mediaEl));\n        } // Trigger loaded for scene to start rendering.\n\n\n        Promise.all(loaded).then(bind(this.load, this)); // Timeout to start loading anyways.\n\n        timeout = parseInt(this.getAttribute('timeout'), 10) || 3000;\n        this.timeout = setTimeout(function () {\n          if (self.hasLoaded) {\n            return;\n          }\n\n          warn('Asset loading timed out in ', timeout, 'ms');\n          self.emit('timeout');\n          self.load();\n        }, timeout);\n      }\n    },\n    detachedCallback: {\n      value: function () {\n        if (this.timeout) {\n          clearTimeout(this.timeout);\n        }\n      }\n    },\n    load: {\n      value: function () {\n        ANode.prototype.load.call(this, null, function waitOnFilter(el) {\n          return el.isAssetItem && el.hasAttribute('src');\n        });\n      }\n    }\n  })\n});\n/**\n * Preload using XHRLoader for any type of asset.\n */\n\nregisterElement('a-asset-item', {\n  prototype: Object.create(ANode.prototype, {\n    createdCallback: {\n      value: function () {\n        this.data = null;\n        this.isAssetItem = true;\n      }\n    },\n    attachedCallback: {\n      value: function () {\n        var self = this;\n        var src = this.getAttribute('src');\n        fileLoader.setResponseType(this.getAttribute('response-type') || inferResponseType(src));\n        fileLoader.load(src, function handleOnLoad(response) {\n          self.data = response;\n          /*\n            Workaround for a Chrome bug. If another XHR is sent to the same url before the\n            previous one closes, the second request never finishes.\n            setTimeout finishes the first request and lets the logic triggered by load open\n            subsequent requests.\n            setTimeout can be removed once the fix for the bug below ships:\n            https://bugs.chromium.org/p/chromium/issues/detail?id=633696&q=component%3ABlink%3ENetwork%3EXHR%20&colspec=ID%20Pri%20M%20Stars%20ReleaseBlock%20Component%20Status%20Owner%20Summary%20OS%20Modified\n          */\n\n          setTimeout(function load() {\n            ANode.prototype.load.call(self);\n          });\n        }, function handleOnProgress(xhr) {\n          self.emit('progress', {\n            loadedBytes: xhr.loaded,\n            totalBytes: xhr.total,\n            xhr: xhr\n          });\n        }, function handleOnError(xhr) {\n          self.emit('error', {\n            xhr: xhr\n          });\n        });\n      }\n    }\n  })\n});\n/**\n * Create a Promise that resolves once the media element has finished buffering.\n *\n * @param {Element} el - HTMLMediaElement.\n * @returns {Promise}\n */\n\nfunction mediaElementLoaded(el) {\n  if (!el.hasAttribute('autoplay') && el.getAttribute('preload') !== 'auto') {\n    return;\n  } // If media specifies autoplay or preload, wait until media is completely buffered.\n\n\n  return new Promise(function (resolve, reject) {\n    if (el.readyState === 4) {\n      return resolve();\n    } // Already loaded.\n\n\n    if (el.error) {\n      return reject();\n    } // Error.\n\n\n    el.addEventListener('loadeddata', checkProgress, false);\n    el.addEventListener('progress', checkProgress, false);\n    el.addEventListener('error', reject, false);\n\n    function checkProgress() {\n      // Add up the seconds buffered.\n      var secondsBuffered = 0;\n\n      for (var i = 0; i < el.buffered.length; i++) {\n        secondsBuffered += el.buffered.end(i) - el.buffered.start(i);\n      } // Compare seconds buffered to media duration.\n\n\n      if (secondsBuffered >= el.duration) {\n        // Set in cache because we won't be needing to call three.js loader if we have.\n        // a loaded media element.\n        // Store video elements only. three.js loader is used for audio elements.\n        // See assetParse too.\n        if (el.tagName === 'VIDEO') {\n          THREE.Cache.files[el.getAttribute('src')] = el;\n        }\n\n        resolve();\n      }\n    }\n  });\n}\n/**\n * Automatically add attributes to media elements where convenient.\n * crossorigin, playsinline.\n */\n\n\nfunction fixUpMediaElement(mediaEl) {\n  // Cross-origin.\n  var newMediaEl = setCrossOrigin(mediaEl); // Plays inline for mobile.\n\n  if (newMediaEl.tagName && newMediaEl.tagName.toLowerCase() === 'video') {\n    newMediaEl.setAttribute('playsinline', '');\n    newMediaEl.setAttribute('webkit-playsinline', '');\n  }\n\n  if (newMediaEl !== mediaEl) {\n    mediaEl.parentNode.appendChild(newMediaEl);\n    mediaEl.parentNode.removeChild(mediaEl);\n  }\n\n  return newMediaEl;\n}\n/**\n * Automatically set `crossorigin` if not defined on the media element.\n * If it is not defined, we must create and re-append a new media element <img> and\n * have the browser re-request it with `crossorigin` set.\n *\n * @param {Element} Media element (e.g., <img>, <audio>, <video>).\n * @returns {Element} Media element to be used to listen to for loaded events.\n */\n\n\nfunction setCrossOrigin(mediaEl) {\n  var newMediaEl;\n  var src; // Already has crossorigin set.\n\n  if (mediaEl.hasAttribute('crossorigin')) {\n    return mediaEl;\n  }\n\n  src = mediaEl.getAttribute('src');\n\n  if (src !== null) {\n    // Does not have protocol.\n    if (src.indexOf('://') === -1) {\n      return mediaEl;\n    } // Determine if cross origin is actually needed.\n\n\n    if (extractDomain(src) === window.location.host) {\n      return mediaEl;\n    }\n  }\n\n  warn('Cross-origin element (e.g., <img>) was requested without `crossorigin` set. ' + 'A-Frame will re-request the asset with `crossorigin` attribute set. ' + 'Please set `crossorigin` on the element (e.g., <img crossorigin=\"anonymous\">)', src);\n  mediaEl.crossOrigin = 'anonymous';\n  newMediaEl = mediaEl.cloneNode(true);\n  return newMediaEl;\n}\n/**\n * Extract domain out of URL.\n *\n * @param {string} url\n * @returns {string}\n */\n\n\nfunction extractDomain(url) {\n  // Find and remove protocol (e.g., http, ftp, etc.) to get domain.\n  var domain = url.indexOf('://') > -1 ? url.split('/')[2] : url.split('/')[0]; // Find and remove port number.\n\n  return domain.substring(0, domain.indexOf(':'));\n}\n/**\n * Infer response-type attribute from src.\n * Default is text (default XMLHttpRequest.responseType)\n * and arraybuffer for .glb files.\n *\n * @param {string} src\n * @returns {string}\n */\n\n\nfunction inferResponseType(src) {\n  var fileName = getFileNameFromURL(src);\n  var dotLastIndex = fileName.lastIndexOf('.');\n\n  if (dotLastIndex >= 0) {\n    var extension = fileName.slice(dotLastIndex, src.search(/\\?|#|$/));\n\n    if (extension === '.glb') {\n      return 'arraybuffer';\n    }\n  }\n\n  return 'text';\n}\n\nmodule.exports.inferResponseType = inferResponseType;\n/**\n * Extract filename from URL\n *\n * @param {string} url\n * @returns {string}\n */\n\nfunction getFileNameFromURL(url) {\n  var parser = document.createElement('a');\n  parser.href = url;\n  var query = parser.search.replace(/^\\?/, '');\n  var filePath = url.replace(query, '').replace('?', '');\n  return filePath.substring(filePath.lastIndexOf('/') + 1);\n}\n\nmodule.exports.getFileNameFromURL = getFileNameFromURL;","map":{"version":3,"sources":["C:/Users/Hannuri/Desktop/RoyalCyber/my-first-app/node_modules/aframe/src/core/a-assets.js"],"names":["ANode","require","bind","debug","registerElement","THREE","fileLoader","FileLoader","warn","module","exports","prototype","Object","create","createdCallback","value","isAssets","timeout","attachedCallback","self","i","loaded","mediaEl","mediaEls","imgEl","imgEls","parentNode","isScene","Error","querySelectorAll","length","fixUpMediaElement","push","Promise","resolve","reject","Cache","files","getAttribute","onload","onerror","src","srcObject","mediaElementLoaded","all","then","load","parseInt","setTimeout","hasLoaded","emit","detachedCallback","clearTimeout","call","waitOnFilter","el","isAssetItem","hasAttribute","data","setResponseType","inferResponseType","handleOnLoad","response","handleOnProgress","xhr","loadedBytes","totalBytes","total","handleOnError","readyState","error","addEventListener","checkProgress","secondsBuffered","buffered","end","start","duration","tagName","newMediaEl","setCrossOrigin","toLowerCase","setAttribute","appendChild","removeChild","indexOf","extractDomain","window","location","host","crossOrigin","cloneNode","url","domain","split","substring","fileName","getFileNameFromURL","dotLastIndex","lastIndexOf","extension","slice","search","parser","document","createElement","href","query","replace","filePath"],"mappings":"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","sourcesContent":["var ANode = require('./a-node');\nvar bind = require('../utils/bind');\nvar debug = require('../utils/debug');\nvar registerElement = require('./a-register-element').registerElement;\nvar THREE = require('../lib/three');\n\nvar fileLoader = new THREE.FileLoader();\nvar warn = debug('core:a-assets:warn');\n\n/**\n * Asset management system. Handles blocking on asset loading.\n */\nmodule.exports = registerElement('a-assets', {\n  prototype: Object.create(ANode.prototype, {\n    createdCallback: {\n      value: function () {\n        this.isAssets = true;\n        this.fileLoader = fileLoader;\n        this.timeout = null;\n      }\n    },\n\n    attachedCallback: {\n      value: function () {\n        var self = this;\n        var i;\n        var loaded = [];\n        var mediaEl;\n        var mediaEls;\n        var imgEl;\n        var imgEls;\n        var timeout;\n\n        if (!this.parentNode.isScene) {\n          throw new Error('<a-assets> must be a child of a <a-scene>.');\n        }\n\n        // Wait for <img>s.\n        imgEls = this.querySelectorAll('img');\n        for (i = 0; i < imgEls.length; i++) {\n          imgEl = fixUpMediaElement(imgEls[i]);\n          loaded.push(new Promise(function (resolve, reject) {\n            // Set in cache because we won't be needing to call three.js loader if we have.\n            // a loaded media element.\n            THREE.Cache.files[imgEls[i].getAttribute('src')] = imgEl;\n            imgEl.onload = resolve;\n            imgEl.onerror = reject;\n          }));\n        }\n\n        // Wait for <audio>s and <video>s.\n        mediaEls = this.querySelectorAll('audio, video');\n        for (i = 0; i < mediaEls.length; i++) {\n          mediaEl = fixUpMediaElement(mediaEls[i]);\n          if (!mediaEl.src && !mediaEl.srcObject) {\n            warn('Audio/video asset has neither `src` nor `srcObject` attributes.');\n          }\n          loaded.push(mediaElementLoaded(mediaEl));\n        }\n\n        // Trigger loaded for scene to start rendering.\n        Promise.all(loaded).then(bind(this.load, this));\n\n        // Timeout to start loading anyways.\n        timeout = parseInt(this.getAttribute('timeout'), 10) || 3000;\n        this.timeout = setTimeout(function () {\n          if (self.hasLoaded) { return; }\n          warn('Asset loading timed out in ', timeout, 'ms');\n          self.emit('timeout');\n          self.load();\n        }, timeout);\n      }\n    },\n\n    detachedCallback: {\n      value: function () {\n        if (this.timeout) { clearTimeout(this.timeout); }\n      }\n    },\n\n    load: {\n      value: function () {\n        ANode.prototype.load.call(this, null, function waitOnFilter (el) {\n          return el.isAssetItem && el.hasAttribute('src');\n        });\n      }\n    }\n  })\n});\n\n/**\n * Preload using XHRLoader for any type of asset.\n */\nregisterElement('a-asset-item', {\n  prototype: Object.create(ANode.prototype, {\n    createdCallback: {\n      value: function () {\n        this.data = null;\n        this.isAssetItem = true;\n      }\n    },\n\n    attachedCallback: {\n      value: function () {\n        var self = this;\n        var src = this.getAttribute('src');\n        fileLoader.setResponseType(\n          this.getAttribute('response-type') || inferResponseType(src));\n        fileLoader.load(src, function handleOnLoad (response) {\n          self.data = response;\n          /*\n            Workaround for a Chrome bug. If another XHR is sent to the same url before the\n            previous one closes, the second request never finishes.\n            setTimeout finishes the first request and lets the logic triggered by load open\n            subsequent requests.\n            setTimeout can be removed once the fix for the bug below ships:\n            https://bugs.chromium.org/p/chromium/issues/detail?id=633696&q=component%3ABlink%3ENetwork%3EXHR%20&colspec=ID%20Pri%20M%20Stars%20ReleaseBlock%20Component%20Status%20Owner%20Summary%20OS%20Modified\n          */\n          setTimeout(function load () { ANode.prototype.load.call(self); });\n        }, function handleOnProgress (xhr) {\n          self.emit('progress', {\n            loadedBytes: xhr.loaded,\n            totalBytes: xhr.total,\n            xhr: xhr\n          });\n        }, function handleOnError (xhr) {\n          self.emit('error', {xhr: xhr});\n        });\n      }\n    }\n  })\n});\n\n/**\n * Create a Promise that resolves once the media element has finished buffering.\n *\n * @param {Element} el - HTMLMediaElement.\n * @returns {Promise}\n */\nfunction mediaElementLoaded (el) {\n  if (!el.hasAttribute('autoplay') && el.getAttribute('preload') !== 'auto') {\n    return;\n  }\n\n  // If media specifies autoplay or preload, wait until media is completely buffered.\n  return new Promise(function (resolve, reject) {\n    if (el.readyState === 4) { return resolve(); }  // Already loaded.\n    if (el.error) { return reject(); }  // Error.\n\n    el.addEventListener('loadeddata', checkProgress, false);\n    el.addEventListener('progress', checkProgress, false);\n    el.addEventListener('error', reject, false);\n\n    function checkProgress () {\n      // Add up the seconds buffered.\n      var secondsBuffered = 0;\n      for (var i = 0; i < el.buffered.length; i++) {\n        secondsBuffered += el.buffered.end(i) - el.buffered.start(i);\n      }\n\n      // Compare seconds buffered to media duration.\n      if (secondsBuffered >= el.duration) {\n        // Set in cache because we won't be needing to call three.js loader if we have.\n        // a loaded media element.\n        // Store video elements only. three.js loader is used for audio elements.\n        // See assetParse too.\n        if (el.tagName === 'VIDEO') {\n          THREE.Cache.files[el.getAttribute('src')] = el;\n        }\n        resolve();\n      }\n    }\n  });\n}\n\n/**\n * Automatically add attributes to media elements where convenient.\n * crossorigin, playsinline.\n */\nfunction fixUpMediaElement (mediaEl) {\n  // Cross-origin.\n  var newMediaEl = setCrossOrigin(mediaEl);\n\n  // Plays inline for mobile.\n  if (newMediaEl.tagName && newMediaEl.tagName.toLowerCase() === 'video') {\n    newMediaEl.setAttribute('playsinline', '');\n    newMediaEl.setAttribute('webkit-playsinline', '');\n  }\n\n  if (newMediaEl !== mediaEl) {\n    mediaEl.parentNode.appendChild(newMediaEl);\n    mediaEl.parentNode.removeChild(mediaEl);\n  }\n  return newMediaEl;\n}\n\n/**\n * Automatically set `crossorigin` if not defined on the media element.\n * If it is not defined, we must create and re-append a new media element <img> and\n * have the browser re-request it with `crossorigin` set.\n *\n * @param {Element} Media element (e.g., <img>, <audio>, <video>).\n * @returns {Element} Media element to be used to listen to for loaded events.\n */\nfunction setCrossOrigin (mediaEl) {\n  var newMediaEl;\n  var src;\n\n  // Already has crossorigin set.\n  if (mediaEl.hasAttribute('crossorigin')) { return mediaEl; }\n\n  src = mediaEl.getAttribute('src');\n\n  if (src !== null) {\n    // Does not have protocol.\n    if (src.indexOf('://') === -1) { return mediaEl; }\n\n    // Determine if cross origin is actually needed.\n    if (extractDomain(src) === window.location.host) { return mediaEl; }\n  }\n\n  warn('Cross-origin element (e.g., <img>) was requested without `crossorigin` set. ' +\n       'A-Frame will re-request the asset with `crossorigin` attribute set. ' +\n       'Please set `crossorigin` on the element (e.g., <img crossorigin=\"anonymous\">)', src);\n  mediaEl.crossOrigin = 'anonymous';\n  newMediaEl = mediaEl.cloneNode(true);\n  return newMediaEl;\n}\n\n/**\n * Extract domain out of URL.\n *\n * @param {string} url\n * @returns {string}\n */\nfunction extractDomain (url) {\n  // Find and remove protocol (e.g., http, ftp, etc.) to get domain.\n  var domain = url.indexOf('://') > -1 ? url.split('/')[2] : url.split('/')[0];\n\n  // Find and remove port number.\n  return domain.substring(0, domain.indexOf(':'));\n}\n\n/**\n * Infer response-type attribute from src.\n * Default is text (default XMLHttpRequest.responseType)\n * and arraybuffer for .glb files.\n *\n * @param {string} src\n * @returns {string}\n */\nfunction inferResponseType (src) {\n  var fileName = getFileNameFromURL(src);\n  var dotLastIndex = fileName.lastIndexOf('.');\n  if (dotLastIndex >= 0) {\n    var extension = fileName.slice(dotLastIndex, src.search(/\\?|#|$/));\n    if (extension === '.glb') {\n      return 'arraybuffer';\n    }\n  }\n  return 'text';\n}\nmodule.exports.inferResponseType = inferResponseType;\n\n/**\n * Extract filename from URL\n *\n * @param {string} url\n * @returns {string}\n */\nfunction getFileNameFromURL (url) {\n  var parser = document.createElement('a');\n  parser.href = url;\n  var query = parser.search.replace(/^\\?/, '');\n  var filePath = url.replace(query, '').replace('?', '');\n  return filePath.substring(filePath.lastIndexOf('/') + 1);\n}\nmodule.exports.getFileNameFromURL = getFileNameFromURL;\n"]},"metadata":{},"sourceType":"script"}